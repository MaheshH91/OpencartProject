name: OpenCart Selenium CI with Maven

on:
  workflow_dispatch:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  schedule:
    - cron: "0 22 * * *"

env:
  BROWSER: chrome
  HEADLESS: true

jobs:
  selenium-tests:
    runs-on: ubuntu-latest

    steps:

    # -------------------------
    # 1. Checkout Code
    # -------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------
    # 2. Install Java 17
    # -------------------------
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: "17"
        distribution: "temurin"
        cache: maven

    # -------------------------
    # 3. Install Google Chrome
    # -------------------------
    - name: Install Google Chrome
      run: |
        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo apt-get update
        sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
        google-chrome --version

    # -------------------------
    # 4. Install ChromeDriver (Chrome-for-Testing API)
    # -------------------------
    - name: Install ChromeDriver
      run: |
        echo "Fetching Last Known Good Versions (LKG)..."
        DRIVER_URL=$(wget -qO- https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json \
          | jq -r '.channels.Stable.downloads.chromedriver[] | select(.platform == "linux64").url')

        echo "Downloading ChromeDriver from: $DRIVER_URL"
        wget -O chromedriver.zip "$DRIVER_URL"
        unzip chromedriver.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver

        chromedriver --version

    # -------------------------
    # 5. Run Selenium Tests
    # -------------------------
    - name: Run Maven Tests (Headless)
      run: |
        mvn clean test \
          -Dbrowser=${{ env.BROWSER }} \
          -Dheadless=${{ env.HEADLESS }} \
          -Dexecution_env=ci

    # -------------------------
    # 6. Upload Extent Report
    # -------------------------
    - name: Upload Extent Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ExtentReport
        path: |
          **/reports/*
          **/ExtentReports/*
          **/test-output/*

    # -------------------------
    # 7. Upload Screenshots
    # -------------------------
    - name: Upload Screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Screenshots
        path: |
          **/screenshots/*
          **/Screenshots/*
